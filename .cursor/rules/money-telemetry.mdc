---
globs:
  - src/telemetry/**/*.py
  - docs/BIG/money_telemetry_schema.md
description: Telemetry and database schema guidelines for money system
---
# Money System Telemetry Guidelines

## Database Schema Extensions (Additive Only)
- `simulation_runs`: `exchange_regime TEXT DEFAULT 'barter_only'`, `money_mode TEXT DEFAULT NULL`, `money_scale INTEGER DEFAULT 1`
- `agent_snapshots`: `inventory_M INTEGER DEFAULT 0`, `lambda_money REAL DEFAULT NULL`, money quote columns (`ask/bid_*_in_M`), `perceived_price_*`, `lambda_changed INTEGER DEFAULT 0`
- `trades`: `dM INTEGER DEFAULT 0`, `exchange_pair_type TEXT`, `buyer/seller_lambda REAL`, `buyer/seller_surplus REAL`
- New tables:
  - `tick_states(run_id, tick, current_mode, exchange_regime, active_pairs)`
  - `lambda_updates(run_id, tick, agent_id, lambda_old, lambda_new, lambda_hat_*, clamped, clamp_type)`
- See details: [docs/BIG/money_telemetry_schema.md](mdc:docs/BIG/money_telemetry_schema.md)

## Logging Requirements
- Always: `tick_states` each tick; `agent_snapshots` each tick (money columns only if regime ≠ barter_only); `trades` with `dM`, `exchange_pair_type`, surplus
- Conditional: `lambda_updates` when significant change; liquidity depth in `mixed_liquidity_gated`; perceived prices in KKT mode

## Query Patterns (Essentials)
- Monetary trades by tick:
```sql
SELECT * FROM trades WHERE run_id = ? AND dM > 0 ORDER BY tick;
```
- Surplus by trade type:
```sql
SELECT exchange_pair_type, COUNT(*) count,
       AVG(buyer_surplus + seller_surplus) avg_total_surplus
FROM trades WHERE run_id = ? GROUP BY exchange_pair_type;
```
- λ trajectory for an agent:
```sql
SELECT tick, lambda_money, inventory_M FROM agent_snapshots
WHERE run_id = ? AND agent_id = ? ORDER BY tick;
```

## Performance & Indexing
- Batch inserts; use prepared statements
- Recommended indices: run/tick on `tick_states`, `agent_snapshots`; `exchange_pair_type` and `dM` on `trades`; λ columns for analysis

## Migration Strategy
- Add columns with `DEFAULT`; create new tables; write conditionally when money disabled
- Validate on legacy/mixed/full-money databases

## Validation Checks
- Money conservation; positive surplus; λ bounds respected; regime ↔ pairs consistent