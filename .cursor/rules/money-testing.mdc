---
globs:
  - tests/test_money*.py
  - tests/test_m1_integration.py
  - tests/test_mode*.py
  - scripts/benchmark_performance.py
description: Testing requirements and validation strategies for money implementation
---
# Money System Testing Guide

## Philosophy
- Phased gates; do not proceed until current phase passes
- Deterministic by construction: fixed seeds, sorted iteration, identical outputs across runs
- Backward compatibility: legacy scenarios unchanged unless explicitly authorized

## Phase Gates
- Phase 1: No behavioral changes to legacy scenarios ✅ COMPLETE
- Phase 2: Basic money trades working ✅ COMPLETE (152 tests passing)
- Phase 3: λ convergence demonstrated (deterministic)
- Phase 4: Mixed regime trade types verified; tie‑breaking
- Phase 5: Liquidity gating validated in heterogeneous density
- Phase 6: Full E2E + regression tests across regimes/modes

## Determinism Requirements
- Use fixed seeds (e.g., `--seed 42`)
- Sort agents/pairs and price lists using stable keys
- Snapshot comparisons for regression

## Required Scenarios (tests/demos)
- `money_test_basic.yaml` (money‑only trades)
- `money_test_kkt.yaml` (λ convergence)
- `money_test_mixed.yaml` (both money and barter)
- `money_test_mode_interaction.yaml` (mode × regime)
- `money_test_liquidity_gate.yaml` (liquidity gating)
- `money_test_sparse_liquidity.yaml` (sparse agents)

## Performance Targets
- Maintain ≥5 TPS on exchange‑only baseline (500 ticks, 400 agents, 50×50)
- No more than 10% overhead vs baseline
- O(N) average; avoid O(N²) paths; SpatialIndex for proximity
- Batch telemetry writes

## Commands
```bash
# Run all tests
pytest -q

# Focused runs
pytest tests/test_money_phase2*.py -v
pytest -k "not money" -v

# Determinism snapshot
python scripts/compare_telemetry_snapshots.py

# Benchmarks
python scripts/benchmark_performance.py
```

## Validation Checklist (per phase)
- Unit + integration tests pass
- Determinism verified (same seed → same output)
- Regression: legacy scenarios unchanged
- Performance targets met
- Telemetry logs as expected
- Documentation updated