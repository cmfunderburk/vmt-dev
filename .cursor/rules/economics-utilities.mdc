---
globs: src/vmt_engine/econ/*.py,src/vmt_engine/systems/matching.py,src/vmt_engine/systems/trading.py,src/vmt_engine/systems/quotes.py
description: Guidelines for economic logic, utility functions, and trading algorithms
---
## Economics & Utility Function Guidelines

### Utility Functions
- Implementations: [src/vmt_engine/econ/utility.py](mdc:src/vmt_engine/econ/utility.py)
- Supported types: CES (`UCES`) and Linear (`ULinear`)
- Factory usage: `create_utility("ces", alpha, rho)`; `create_utility("linear", alpha)`

### Zero-Inventory Guard
- Use epsilon only in reservation‑bounds ratio; never in utility itself
- Utility must consume true integer inventories
- See implementation and tests for examples

### Reservation Prices & Quotes
- Bounds: `p_min, p_max = utility.reservation_bounds_A_in_B(A, B, epsilon)`
- Quotes add spread: `ask = p_min*(1+spread)`, `bid = p_max*(1−spread)`
- Quotes refresh only in Housekeeping when `agent.inventory_changed=True`

### Trading Algorithm (essentials)
- Partner selection: maximize positive surplus
- Price search: probe candidate prices p ∈ [ask_seller, bid_buyer] and ΔA ∈ [1..dA_max]
- Rounding: map quantities with round‑half‑up `floor(p*ΔA + 0.5)`
- Accept first trade with strict ΔU>0 for both agents; set cooldowns on failure
- Execute inventory updates with integers; set `inventory_changed=True`; log trade

### Economic Correctness
- Required: strict utility improvement; inventory feasibility; conservation of goods; determinism; integer quantities; consistent round‑half‑up
- Common mistakes: ΔU≥0 acceptance; epsilon in utility; inconsistent rounding; mutating quotes mid‑tick; float inventories

### Testing Pointers
- See: [tests/test_utility_ces.py](mdc:tests/test_utility_ces.py), [tests/test_utility_linear.py](mdc:tests/test_utility_linear.py)

### Tuning Parameters (typical ranges)
- spread: 0.05–0.10; dA_max: 3–10; epsilon: 0.001–0.01
- alpha: 0.3–0.7; rho: −1 to 1; beta: 0.9–0.99; trade_cooldown_ticks: 5–20

### References
- Economic theory: [docs/2_technical_manual.md](mdc:docs/2_technical_manual.md)
- Type contracts: [docs/4_typing_overview.md](mdc:docs/4_typing_overview.md)
- Implementation: [src/vmt_engine/econ/utility.py](mdc:src/vmt_engine/econ/utility.py)
